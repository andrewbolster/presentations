name: Build and Deploy Presentations

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install demo dependencies
        run: |
          cd demo
          npm install

      - name: Build demo presentation
        run: |
          cd demo
          npx slidev build --base /presentations/demo/
          # Copy build output from dist to demo directory
          cp -r dist/* .
          # Create 404.html in demo directory (for demo-specific 404s)
          cp index.html 404.html
          # IMPORTANT: Copy 404.html to root for GitHub Pages SPA routing
          cp index.html ../404.html

      - name: Inject commit hash into root index.html
        run: |
          COMMIT_HASH="${{ github.sha }}"
          COMMIT_HASH_SHORT="${COMMIT_HASH:0:7}"
          sed -i "s/__COMMIT_HASH__/$COMMIT_HASH/g" index.html
          sed -i "s/__COMMIT_HASH_SHORT__/$COMMIT_HASH_SHORT/g" index.html
          echo "Injected commit: $COMMIT_HASH_SHORT"

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          exclude_assets: '.github,node_modules,.slidev,demo/node_modules,demo/.slidev'
          enable_jekyll: false
          force_orphan: false
